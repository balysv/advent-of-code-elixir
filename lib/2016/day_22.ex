defmodule AdventOfCode.Y2016.Day22 do
  defp prepare_input(raw) do
    raw
    |> String.split("\n", trim: true)
    |> Enum.slice(2..-1)
    #  /dev/grid/node-x0-y0     92T   73T    19T   79%
    |> Enum.map(fn line ->
      [x, y, _, used, avail, _] =
        Regex.run(
          ~r/\/dev\/grid\/node-x(\d+)-y(\d+)[ ]+(\d+)T[ ]+(\d+)T[ ]+(\d+)T[ ]+(\d+)%/,
          line,
          capture: :all_but_first
        )
        |> Enum.map(&String.to_integer/1)

      {{x, y}, {used, avail}}
    end)
    |> Enum.into(%{})
  end

  def part1(args) do
    args |> prepare_input() |> viable_pairs() |> length()
  end

  defp viable_pairs(nodes) do
    for n1 = {_, {used, _}} <- nodes,
        n2 = {_, {_, avail}} <- nodes,
        n1 != n2,
        used != 0,
        avail >= used do
      {n1, n2}
    end
  end

  def part2(args) do
    # start is {0, 0}
    # there's only one empty node {4, 25} that can be used for moving
    # target is {29, 0}
    nodes = args |> prepare_input()
    empty_node = viable_pairs(nodes) |> Enum.map(&elem(&1, 1)) |> Enum.uniq() |> hd()
    target = Enum.max_by(nodes, fn {{x, _}, _} -> x end)

    print(nodes)
    # 58 - steps for the "hole" to swap with the target, going around "large" nodes
    # 5 - steps needed to go "around" the target to move it
    # 28 - number of iterations to get target to the start
    58 + 5 * 28
  end

  defp print(nodes) do
    for y <- 0..34, x <- 0..29 do
      {used, avail} = Map.get(nodes, {x, y})

      cond do
        used == 0 -> IO.write(String.pad_trailing("_____", 7))
        used > 100 -> IO.write(String.pad_trailing("XXXXX", 7))
        {x, y} == {29, 0} -> IO.write(String.pad_trailing("#####", 7))
        true -> IO.write(String.pad_trailing("#{used}/#{avail} ", 7))
      end

      if x == 29, do: IO.puts("")
    end
  end

  """
  73/19  73/18  65/29  67/24  66/26  65/21  70/20  64/26  66/21  65/22  68/25  73/21  65/29  72/20  66/19  68/26  72/17  72/18  67/20  70/20  64/28  64/24  71/14  69/16  70/23  66/21  69/22  65/22  69/17  #####
  66/25  69/25  68/17  70/15  66/19  68/17  65/26  69/24  64/26  66/21  72/15  72/16  70/23  66/22  70/24  65/22  66/19  66/19  71/20  68/22  68/21  66/22  68/22  69/23  66/22  70/20  71/22  73/19  69/25  71/22
  73/12  66/23  66/28  67/24  72/14  67/22  66/27  64/23  68/26  66/23  69/21  66/26  66/27  70/20  68/24  65/24  65/26  67/19  70/15  65/26  64/27  67/23  64/30  64/21  67/25  69/19  65/23  71/20  65/24  70/20
  68/17  72/22  72/17  66/27  67/23  71/21  65/23  71/19  68/24  73/13  67/22  65/22  72/13  73/17  71/15  66/27  64/26  66/19  68/21  72/15  68/22  70/17  64/22  72/16  66/25  70/15  69/19  73/12  68/18  65/26
  67/20  65/24  70/18  70/24  67/24  66/27  73/17  64/25  68/24  73/15  66/24  70/23  71/22  72/14  71/19  72/18  67/21  66/27  66/24  67/20  72/22  71/20  69/17  68/19  70/15  72/18  64/23  73/13  73/13  71/21
  69/19  69/20  71/20  71/23  72/22  73/16  64/22  70/22  66/25  70/24  72/17  72/17  67/26  72/13  68/24  73/21  71/20  64/21  65/22  64/27  70/23  67/22  71/23  70/15  65/20  72/13  73/15  70/23  70/20  67/22
  68/20  66/21  69/19  70/24  66/19  71/16  73/18  72/15  73/21  73/18  65/23  71/22  71/16  65/27  65/29  67/22  69/24  72/21  70/19  69/18  64/29  65/28  65/22  70/18  70/17  67/24  73/16  72/18  65/21  71/23
  66/26  64/28  66/23  64/29  66/21  70/15  65/27  66/24  65/20  73/20  72/16  66/23  71/15  72/15  67/22  70/15  66/25  65/23  71/14  72/16  70/21  69/18  70/20  70/18  70/21  66/28  69/19  64/26  64/24  71/18
  69/20  69/16  70/20  70/20  72/19  65/26  68/25  69/25  73/17  73/12  65/28  67/26  71/14  68/18  70/17  68/18  71/16  70/22  69/22  73/18  68/19  65/22  68/18  66/26  65/28  67/22  67/19  69/16  68/24  73/14
  73/17  69/24  71/19  64/27  66/26  69/17  65/27  66/19  72/14  69/19  67/24  72/17  68/26  70/20  70/19  70/22  72/22  64/21  68/26  68/18  68/24  66/21  72/19  65/26  67/19  71/17  70/15  64/27  68/23  70/20
  72/18  70/18  69/21  72/18  70/23  71/15  67/19  71/18  72/21  65/21  68/20  65/25  69/17  67/19  70/21  65/28  69/22  72/19  71/14  68/18  71/16  65/23  68/22  68/24  72/15  66/24  65/27  64/30  73/18  70/18
  72/15  70/17  68/17  64/24  65/24  69/19  66/25  66/25  72/19  66/22  65/20  66/25  67/26  67/26  65/26  67/21  65/27  73/20  68/25  71/23  70/19  65/20  73/15  73/17  64/24  66/27  64/21  70/23  73/15  68/19
  71/16  70/20  67/27  73/14  70/20  66/26  72/17  68/25  64/26  73/14  64/29  70/24  66/20  64/26  72/20  69/18  69/20  73/21  72/21  66/27  66/19  73/16  64/23  70/22  73/20  65/20  72/17  73/13  65/24  70/18
  71/16  64/30  70/17  73/18  69/17  65/20  72/15  66/25  71/20  65/27  65/28  64/23  71/19  72/14  66/28  67/26  66/21  65/22  70/15  69/19  69/25  66/20  68/25  65/29  71/21  68/19  67/21  66/23  64/29  73/14
  71/19  72/17  67/27  64/30  72/13  67/19  71/21  73/14  64/21  69/23  65/22  64/24  65/20  69/24  71/17  67/18  64/25  68/17  64/26  70/15  67/26  67/25  69/24  67/27  68/21  71/17  73/14  73/17  72/17  66/27
  64/22  71/22  64/29  70/24  68/20  72/16  64/25  68/20  68/25  70/20  70/21  64/21  68/20  71/20  71/20  73/18  64/25  72/18  67/18  73/12  70/18  73/18  67/27  66/20  71/23  72/19  64/21  70/21  65/27  71/18
  69/16  XXXXX  XXXXX  XXXXX  XXXXX  XXXXX  XXXXX  XXXXX  XXXXX  XXXXX  XXXXX  XXXXX  XXXXX  XXXXX  XXXXX  XXXXX  XXXXX  XXXXX  XXXXX  XXXXX  XXXXX  XXXXX  XXXXX  XXXXX  XXXXX  XXXXX  XXXXX  XXXXX  XXXXX  XXXXX
  68/23  73/14  70/16  69/25  67/25  70/18  71/14  72/21  68/24  65/23  67/25  71/16  67/22  64/29  69/16  65/26  72/16  64/24  73/13  65/29  72/13  71/15  64/23  70/23  68/26  69/25  64/21  70/15  67/18  71/22
  73/12  71/17  70/24  66/26  66/28  71/16  67/19  65/21  67/18  73/19  73/20  73/16  68/25  65/25  67/19  64/22  68/23  72/22  72/20  67/25  65/24  67/19  70/22  65/27  69/21  71/16  70/21  67/23  64/28  72/16
  66/27  68/19  64/25  73/21  66/21  71/21  71/18  71/21  67/24  70/17  67/21  73/19  64/22  65/21  68/21  73/13  64/23  66/22  65/25  64/25  67/19  69/17  69/16  70/21  72/17  73/13  70/20  66/21  68/21  71/19
  66/22  73/12  70/17  66/24  69/22  69/21  67/19  65/28  71/20  64/23  69/19  66/21  66/25  66/20  72/22  68/21  72/16  70/16  64/23  67/19  67/26  70/20  68/24  69/21  70/18  69/23  72/13  73/12  72/17  67/22
  70/15  69/24  65/27  67/22  66/27  69/22  68/24  67/26  73/18  65/27  66/19  64/27  71/19  71/15  71/15  69/20  73/19  73/14  73/17  69/24  66/24  65/27  73/13  71/22  65/28  66/19  66/28  67/25  72/14  66/24
  67/22  68/26  71/22  67/25  68/21  66/22  71/15  67/25  73/16  71/21  68/22  65/27  71/22  64/25  67/23  67/20  69/18  71/20  72/13  66/28  71/23  71/22  65/26  67/26  68/21  71/18  67/24  66/20  71/17  64/21
  64/28  71/17  64/29  68/22  68/21  68/26  68/20  72/22  70/18  69/25  71/19  66/26  68/17  68/24  69/17  65/22  68/19  67/18  73/14  72/20  73/20  67/21  64/29  69/17  64/21  70/17  65/27  69/23  64/26  66/28
  68/24  69/20  66/28  68/17  65/25  64/25  71/21  64/28  71/23  73/16  73/12  65/25  68/26  67/18  65/28  65/22  65/28  66/23  67/21  70/24  67/23  66/26  65/25  69/18  71/22  67/26  70/20  69/20  64/25  69/25
  64/27  67/21  70/19  67/22  _____  69/17  68/25  73/20  73/19  66/21  70/15  73/18  67/27  69/20  71/23  67/20  64/21  64/25  67/23  68/25  70/24  65/27  65/21  73/19  67/19  73/16  64/22  65/24  69/19  71/20
  67/18  67/19  67/19  71/17  71/21  73/12  65/21  73/12  69/17  67/23  73/21  65/28  73/21  69/22  67/27  70/18  68/20  73/13  67/18  66/27  67/26  73/12  70/20  66/23  70/16  64/21  69/20  70/20  67/24  67/19
  72/17  72/20  65/24  71/14  69/21  70/22  68/21  71/20  71/16  73/21  67/24  66/20  67/18  69/20  73/20  72/13  64/28  71/22  72/14  70/23  70/18  64/27  71/20  68/26  64/27  68/23  66/20  67/19  73/14  68/17
  65/21  73/21  73/17  65/24  68/25  69/20  64/23  72/20  65/27  67/24  64/24  71/17  68/25  69/21  66/22  65/26  67/26  70/24  71/22  69/16  72/20  66/24  70/24  70/22  70/18  65/23  71/14  65/21  65/22  73/13
  72/19  64/30  67/26  69/19  65/28  65/22  67/27  64/24  65/29  73/15  70/17  65/22  72/13  71/23  65/29  73/21  64/29  65/24  64/24  72/19  64/25  65/29  68/21  71/20  69/21  72/15  70/23  65/29  65/20  64/28
  66/24  67/21  66/28  70/19  70/18  73/19  69/20  69/21  73/18  73/12  69/18  69/22  72/16  68/24  73/14  66/25  71/15  66/23  73/16  69/16  71/14  72/20  73/14  73/20  67/20  68/19  69/22  70/20  71/15  71/23
  70/20  66/20  66/21  72/22  70/23  68/18  64/22  70/20  69/16  65/28  71/23  65/20  70/17  66/21  67/26  71/23  70/22  68/26  67/22  69/16  66/28  69/25  69/23  64/24  64/21  64/21  70/24  67/27  66/26  70/15
  65/25  64/29  69/21  71/14  68/26  73/15  71/15  66/21  68/20  67/22  66/21  65/29  70/16  64/27  69/19  69/17  71/17  73/16  65/26  72/19  71/18  66/22  66/23  73/20  70/23  67/26  69/19  71/19  72/17  64/28
  73/17  66/27  73/17  65/25  71/18  73/12  71/18  72/19  66/20  70/21  70/22  71/14  65/26  65/23  68/18  69/17  69/20  73/13  70/21  68/19  73/16  64/30  66/21  71/19  68/17  66/24  71/17  66/26  65/25  67/21
  69/24  68/20  65/26  69/19  69/24  72/15  72/14  64/22  70/22  73/13  68/23  68/25  69/24  66/26  70/16  65/25  68/26  64/26  70/18  70/16  72/21  66/25  67/20  64/29  70/23  67/19  67/20  72/22  65/20  73/13
  """
end
